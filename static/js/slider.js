// Tasks and Data
const tasks = ["teaser", "tryon", "stylization", "character"];

const data = {
    "teaser": {
        "use_20": false,
        "use_two_sided": true,
        "data": [
            {
                title: [
                    "A photo of a happy person, standing on a branch, climbing a tree, surrounded by a dense jungle",
                    "A photo of a joyful person, standing on a board, surfing a wave, in the ocean",
                    "A photo of an angry person, leaning forward, riding a bicycle on a cobblestone street, surrounded by old buildings",
                    "A photo of a focused person, sitting on a rock, sketching on paper, with mountains in the background",
                    "A photo of a focused person, kneeling down, planting flowers, with a modern house in the background",
                    "A photo of a peaceful person, sitting, playing guitar at sunset, with a colorful sky in the background",
                    "A photo of a happy person, stirring something in a pan, cooking a meal, in a modern kitchen",
                    "A photo of a heroic person, riding a beautiful unicorn, galloping through a rainbow, in a fantasy landscape",
                    "A photo of a playful person, jumping in puddles, having fun in the rain, in a city street",
                    "A photo of a busy person, typing on a laptop, working diligently, in a modern office",
                    "A photo of a delighted person, opening a gift, celebrating Christmas, in front of a Christmas tree",
                    "A photo of a thoughtful person, looking out a window, reflecting on life, in a cozy room",
                ],
                input_image: "static/images/teaser_webp/ppr10k_1/input.webp",
                images: [
                    "static/images/teaser_webp/ppr10k_1/jungle.webp",
                    "static/images/teaser_webp/ppr10k_1/surfing.webp",
                    "static/images/teaser_webp/ppr10k_1/bicycle.webp",
                    "static/images/teaser_webp/ppr10k_1/sketch.webp",
                    "static/images/teaser_webp/ppr10k_1/flower.webp",
                    "static/images/teaser_webp/ppr10k_1/guitar.webp",
                    "static/images/teaser_webp/ppr10k_1/cooking.webp",
                    "static/images/teaser_webp/ppr10k_1/unicorn.webp",
                    "static/images/teaser_webp/ppr10k_1/rainy.webp",
                    "static/images/teaser_webp/ppr10k_1/laptop.webp",
                    "static/images/teaser_webp/ppr10k_1/gift.webp",
                    "static/images/teaser_webp/ppr10k_1/reflect.webp",
                ]
            },

            {
                title: [
                    "A photo of a happy person, standing on a branch, climbing a tree, surrounded by a dense jungle",
                    "A photo of a joyful person, standing on a board, surfing a wave, in the ocean",
                    "A photo of an angry person, leaning forward, riding a bicycle on a cobblestone street, surrounded by old buildings",
                    "A photo of a focused person, sitting on a rock, sketching on paper, with mountains in the background",
                    "A photo of a focused person, kneeling down, planting flowers, with a modern house in the background",
                    "A photo of a peaceful person, sitting, playing guitar at sunset, with a colorful sky in the background",
                    "A photo of a happy person, stirring something in a pan, cooking a meal, in a modern kitchen",
                    "A photo of a heroic person, riding a beautiful unicorn, galloping through a rainbow, in a fantasy landscape",
                    "A photo of a playful person, jumping in puddles, having fun in the rain, in a city street",
                    "A photo of a busy person, typing on a laptop, working diligently, in a modern office",
                    "A photo of a delighted person, opening a gift, celebrating Christmas, in front of a Christmas tree",
                    "A photo of a thoughtful person, looking out a window, reflecting on life, in a cozy room",
                ],
                input_image: "static/images/teaser_webp/ppr10k_2/input.webp",
                images: [
                    "static/images/teaser_webp/ppr10k_2/jungle.webp",
                    "static/images/teaser_webp/ppr10k_2/surfing.webp",
                    "static/images/teaser_webp/ppr10k_2/bicycle.webp",
                    "static/images/teaser_webp/ppr10k_2/sketch.webp",
                    "static/images/teaser_webp/ppr10k_2/flower.webp",
                    "static/images/teaser_webp/ppr10k_2/guitar.webp",
                    "static/images/teaser_webp/ppr10k_2/cooking.webp",
                    "static/images/teaser_webp/ppr10k_2/unicorn.webp",
                    "static/images/teaser_webp/ppr10k_2/rainy.webp",
                    "static/images/teaser_webp/ppr10k_2/laptop.webp",
                    "static/images/teaser_webp/ppr10k_2/gift.webp",
                    "static/images/teaser_webp/ppr10k_2/reflect.webp",
                ]
            },

            {
                title: [
                    "A photo of a happy person, standing on a branch, climbing a tree, surrounded by a dense jungle",
                    "A photo of a joyful person, standing on a board, surfing a wave, in the ocean",
                    "A photo of an angry person, leaning forward, riding a bicycle on a cobblestone street, surrounded by old buildings",
                    "A photo of a focused person, sitting on a rock, sketching on paper, with mountains in the background",
                    "A photo of a focused person, kneeling down, planting flowers, with a modern house in the background",
                    "A photo of a peaceful person, sitting, playing guitar at sunset, with a colorful sky in the background",
                    "A photo of a happy person, stirring something in a pan, cooking a meal, in a modern kitchen",
                    "A photo of a heroic person, riding a beautiful unicorn, galloping through a rainbow, in a fantasy landscape",
                    "A photo of a playful person, jumping in puddles, having fun in the rain, in a city street",
                    "A photo of a busy person, typing on a laptop, working diligently, in a modern office",
                    "A photo of a delighted person, opening a gift, celebrating Christmas, in front of a Christmas tree",
                    "A photo of a thoughtful person, looking out a window, reflecting on life, in a cozy room",
                ],
                input_image: "static/images/teaser_webp/ppr10k_3/input.webp",
                images: [
                    "static/images/teaser_webp/ppr10k_3/jungle.webp",
                    "static/images/teaser_webp/ppr10k_3/surfing.webp",
                    "static/images/teaser_webp/ppr10k_3/bicycle.webp",
                    "static/images/teaser_webp/ppr10k_3/sketch.webp",
                    "static/images/teaser_webp/ppr10k_3/flower.webp",
                    "static/images/teaser_webp/ppr10k_3/guitar.webp",
                    "static/images/teaser_webp/ppr10k_3/cooking.webp",
                    "static/images/teaser_webp/ppr10k_3/unicorn.webp",
                    "static/images/teaser_webp/ppr10k_3/rainy.webp",
                    "static/images/teaser_webp/ppr10k_3/laptop.webp",
                    "static/images/teaser_webp/ppr10k_3/gift.webp",
                    "static/images/teaser_webp/ppr10k_3/reflect.webp",
                ]
            },

            {
                title: [
                    "A photo of a happy person, standing on a branch, climbing a tree, surrounded by a dense jungle",
                    "A photo of a joyful person, standing on a board, surfing a wave, in the ocean",
                    "A photo of an angry person, leaning forward, riding a bicycle on a cobblestone street, surrounded by old buildings",
                    "A photo of a focused person, sitting on a rock, sketching on paper, with mountains in the background",
                    "A photo of a focused person, kneeling down, planting flowers, with a modern house in the background",
                    "A photo of a peaceful person, sitting, playing guitar at sunset, with a colorful sky in the background",
                    "A photo of a happy person, stirring something in a pan, cooking a meal, in a modern kitchen",
                    "A photo of a heroic person, riding a beautiful unicorn, galloping through a rainbow, in a fantasy landscape",
                    "A photo of a playful person, jumping in puddles, having fun in the rain, in a city street",
                    "A photo of a busy person, typing on a laptop, working diligently, in a modern office",
                    "A photo of a delighted person, opening a gift, celebrating Christmas, in front of a Christmas tree",
                    "A photo of a thoughtful person, looking out a window, reflecting on life, in a cozy room",
                ],
                input_image: "static/images/teaser_webp/sshq_1/input.webp",
                images: [
                    "static/images/teaser_webp/sshq_1/jungle.webp",
                    "static/images/teaser_webp/sshq_1/surfing.webp",
                    "static/images/teaser_webp/sshq_1/bicycle.webp",
                    "static/images/teaser_webp/sshq_1/sketch.webp",
                    "static/images/teaser_webp/sshq_1/flower.webp",
                    "static/images/teaser_webp/sshq_1/guitar.webp",
                    "static/images/teaser_webp/sshq_1/cooking.webp",
                    "static/images/teaser_webp/sshq_1/unicorn.webp",
                    "static/images/teaser_webp/sshq_1/rainy.webp",
                    "static/images/teaser_webp/sshq_1/laptop.webp",
                    "static/images/teaser_webp/sshq_1/gift.webp",
                    "static/images/teaser_webp/sshq_1/reflect.webp",
                ]
            },

            {
                title: [
                    "A photo of a happy person, standing on a branch, climbing a tree, surrounded by a dense jungle",
                    "A photo of a joyful person, standing on a board, surfing a wave, in the ocean",
                    "A photo of an angry person, leaning forward, riding a bicycle on a cobblestone street, surrounded by old buildings",
                    "A photo of a focused person, sitting on a rock, sketching on paper, with mountains in the background",
                    "A photo of a focused person, kneeling down, planting flowers, with a modern house in the background",
                    "A photo of a peaceful person, sitting, playing guitar at sunset, with a colorful sky in the background",
                    "A photo of a happy person, stirring something in a pan, cooking a meal, in a modern kitchen",
                    "A photo of a heroic person, riding a beautiful unicorn, galloping through a rainbow, in a fantasy landscape",
                    "A photo of a playful person, jumping in puddles, having fun in the rain, in a city street",
                    "A photo of a busy person, typing on a laptop, working diligently, in a modern office",
                    "A photo of a delighted person, opening a gift, celebrating Christmas, in front of a Christmas tree",
                    "A photo of a thoughtful person, looking out a window, reflecting on life, in a cozy room",
                ],
                input_image: "static/images/teaser_webp/sshq_2/input.webp",
                images: [
                    "static/images/teaser_webp/sshq_2/jungle.webp",
                    "static/images/teaser_webp/sshq_2/surfing.webp",
                    "static/images/teaser_webp/sshq_2/bicycle.webp",
                    "static/images/teaser_webp/sshq_2/sketch.webp",
                    "static/images/teaser_webp/sshq_2/flower.webp",
                    "static/images/teaser_webp/sshq_2/guitar.webp",
                    "static/images/teaser_webp/sshq_2/cooking.webp",
                    "static/images/teaser_webp/sshq_2/unicorn.webp",
                    "static/images/teaser_webp/sshq_2/rainy.webp",
                    "static/images/teaser_webp/sshq_2/laptop.webp",
                    "static/images/teaser_webp/sshq_2/gift.webp",
                    "static/images/teaser_webp/sshq_2/reflect.webp",
                ]
            },

            {
                title: [
                    "A photo of a happy person, standing on a branch, climbing a tree, surrounded by a dense jungle",
                    "A photo of a joyful person, standing on a board, surfing a wave, in the ocean",
                    "A photo of an angry person, leaning forward, riding a bicycle on a cobblestone street, surrounded by old buildings",
                    "A photo of a focused person, sitting on a rock, sketching on paper, with mountains in the background",
                    "A photo of a focused person, kneeling down, planting flowers, with a modern house in the background",
                    "A photo of a peaceful person, sitting, playing guitar at sunset, with a colorful sky in the background",
                    "A photo of a happy person, stirring something in a pan, cooking a meal, in a modern kitchen",
                    "A photo of a heroic person, riding a beautiful unicorn, galloping through a rainbow, in a fantasy landscape",
                    "A photo of a playful person, jumping in puddles, having fun in the rain, in a city street",
                    "A photo of a busy person, typing on a laptop, working diligently, in a modern office",
                    "A photo of a delighted person, opening a gift, celebrating Christmas, in front of a Christmas tree",
                    "A photo of a thoughtful person, looking out a window, reflecting on life, in a cozy room",
                ],
                input_image: "static/images/teaser_webp/sshq_3/input.webp",
                images: [
                    "static/images/teaser_webp/sshq_3/jungle.webp",
                    "static/images/teaser_webp/sshq_3/surfing.webp",
                    "static/images/teaser_webp/sshq_3/bicycle.webp",
                    "static/images/teaser_webp/sshq_3/sketch.webp",
                    "static/images/teaser_webp/sshq_3/flower.webp",
                    "static/images/teaser_webp/sshq_3/guitar.webp",
                    "static/images/teaser_webp/sshq_3/cooking.webp",
                    "static/images/teaser_webp/sshq_3/unicorn.webp",
                    "static/images/teaser_webp/sshq_3/rainy.webp",
                    "static/images/teaser_webp/sshq_3/laptop.webp",
                    "static/images/teaser_webp/sshq_3/gift.webp",
                    "static/images/teaser_webp/sshq_3/reflect.webp",
                ]
            },
            
        ]
    },
    "tryon": {
        "use_20": false,
        "use_two_sided": true,
        "data" : [
            {
                title: [
                    "A photo of an angry person, leaning forward, riding a bicycle on a cobblestone street, surrounded by old buildings",
                    "A tired person, running mid-stride, joggin through a city, surrounded by tall buildings",
                    "A photo of a focused person, sitting on a rock, sketching on paper, with mountains in the background",
                ],
                input_image: "static/images/application/virtual-tryon/input.png",
                images: [
                    "static/images/application/virtual-tryon/bicycle.png",
                    "static/images/application/virtual-tryon/jogging.png",
                    "static/images/application/virtual-tryon/sketch.png"
                ]
            }
        ]
    },
    "stylization": {
        "use_20": false,
        "use_two_sided": true,
        "data" : [
            {
                title: [
                    "Anime",
                    "Watercolor",
                    "Pixelart"
                ],
                input_image: "static/images/application/stylization/input.png",
                images: [
                    "static/images/application/stylization/anime.png",
                    "static/images/application/stylization/watercolor.png",
                    "static/images/application/stylization/pixelart.png"
                ]
            }
        ]
    },
    "character": {
        "use_20": false,
        "use_two_sided": true,
        "data" : [
            {
                title: [
                    "Playing the guitar",
                    "Opening the gift",
                    "Skiing downhill"
                ],
                input_image: "static/images/application/character/input.png",
                images: [
                    "static/images/application/character/guitar.png",
                    "static/images/application/character/gift.png",
                    "static/images/application/character/skiing.png"
                ]
            }
        ]
    }
};

let slideIndex = 1;
let currentSceneIndex = {};
let twenty_inited = {};
for (let i = 0; i < tasks.length; i++) {
    currentSceneIndex[tasks[i]] = 0;
    twenty_inited[tasks[i]] = false;
}

// Generate the slides and thumbnails dynamically
function generateSlides(taskName) {
    const slideshowContainer = $("#" + taskName + "-container");
    let slidesHTML = "";
    let thumbnailsHTML = "";
    let scenes = data[taskName]["data"];
    let use_20 = data[taskName]["use_20"];
    let use_two_sided = data[taskName]["use_two_sided"];

    if (use_20) {
        scenes.forEach((scene, sceneIndex) => {
            slidesHTML += `
                <div class="${taskName}-mySlides ${taskName}-scene-${sceneIndex} outer-container">
                    <div class="twenty-container">
            `;
            scene.images.forEach((image) => {
                slidesHTML += `
                    <img class="main-image" src="${image}" alt="${scene.title}">
                `;
            });
            slidesHTML += `
                    </div> 
                </div>
            `;

            thumbnailsHTML += `
                <div class="carousel-column">
                    <img class="${taskName}-demo cursor" src="${scene.images[0]}" data-scene-index="${sceneIndex}" alt="${scene.title}">
                </div>
            `;
        });

        slideshowContainer.html(`
            <div class="container" style="position: relative;">
                ${slidesHTML}

                <!-- Caption container -->
                <div class="caption-container">
                    <p id="${taskName}-caption">${scenes[currentSceneIndex[taskName]].title}</p>
                </div>

                <!-- Thumbnails -->
                <div class="carousel-row">
                    ${thumbnailsHTML}
                </div>
            </div>
        `);
    }
    else if (use_two_sided) {
        let slidesHTML = '';
        let thumbnailsHTML = '';
        let currentScene = scenes[currentSceneIndex[taskName]];
        let first_caption = typeof currentScene.title === 'string' ? currentScene.title : currentScene.title[0];

        scenes.forEach((scene, sceneIndex) => {
            scene.images.forEach((image, index) => {
                slidesHTML += `
                    <div class="${taskName}-mySlides ${taskName}-scene-${sceneIndex} outer-container">
                        <img class="main-image" src="${image}" alt="${scene.title}">
                    </div>
                `;
            });

            thumbnailsHTML += `
                <div class="carousel-column">
                    <img class="${taskName}-demo cursor" src="${scene.input_image}" data-scene-index="${sceneIndex}" alt="${scene.title}">
                </div>
            `;
        });

        const inputImageHTML = `
            <div class="col-sm-4" style="height: 100%; max-width: 50%">
                <img class="main-image" src="${currentScene.input_image}" alt="Input Image">
            </div>
        `;

        const carouselHTML = `
            <div class="col-sm-8 container">
                <div style="position: relative;">
                    ${slidesHTML}
                    ${scenes[0].images.length > 1 ? `
                        <a class="two-prev" data-task-name="${taskName}">❮</a>
                        <a class="two-next" data-task-name="${taskName}">❯</a>
                    ` : ''}
                </div>
            </div>
        `;

        slideshowContainer.html(`
            <div class="container">
                <div class="row" style="height: 500px; max-width: 100%; background: #f5f5f5; margin: 0; display: flex">
                    ${inputImageHTML}
                    ${carouselHTML}
                </div>
                <div class="caption-container">
                    <p id="${taskName}-caption">${first_caption}</p>
                </div>
                <div class="carousel-row">
                    ${thumbnailsHTML}
                </div>
            </div>
        `);
    }
    else {
        scenes.forEach((scene, sceneIndex) => {
            scene.images.forEach((image, index) => {
                slidesHTML += `
                    <div class="${taskName}-mySlides ${taskName}-scene-${sceneIndex} outer-container">
                        <div class="numbertext">${sceneIndex + 1}.${index + 1} / ${scene.images.length}</div>
                        <img class="main-image" src="${image}" alt="${scene.title}">
                    </div>
                `;
            });

            thumbnailsHTML += `
                <div class="carousel-column">
                    <img class="${taskName}-demo cursor" src="${scene.images[0]}" data-scene-index="${sceneIndex}" alt="${scene.title}">
                </div>
            `;
        });
        if (scenes[0].images.length > 1) { 
            slideshowContainer.html(`
                <div class="container" style="position: relative;">
                    ${slidesHTML}

                    <!-- Navigation arrows -->
                    <a class="prev" data-task-name="${taskName}">❮</a>
                    <a class="next" data-task-name="${taskName}">❯</a>

                    <!-- Caption container -->
                    <div class="caption-container">
                        <p id="${taskName}-caption">${scenes[currentSceneIndex[taskName]].title}</p>
                    </div>

                    <!-- Thumbnails -->
                    <div class="carousel-row">
                        ${thumbnailsHTML}
                    </div>
                </div>
            `);
        }
        else{
            slideshowContainer.html(`
                <div class="container" style="position: relative;">
                    ${slidesHTML}

                    <!-- Caption container -->
                    <div class="caption-container">
                        <p id="${taskName}-caption">${scenes[currentSceneIndex[taskName]].title}</p>
                    </div>

                    <!-- Thumbnails -->
                    <div class="carousel-row">
                        ${thumbnailsHTML}
                    </div>
                </div>
            `);
        }
    }

    // Initialize the first slide
    showSlides(slideIndex, taskName);
}

function plusSlides(n, taskName) {
    let scenes = data[taskName]["data"];
    if (n > 0) {
        console.log(currentSceneIndex[taskName])
        if (slideIndex === scenes[currentSceneIndex[taskName]].images.length) {
            slideIndex = 1;
        } else {
            slideIndex += n;
        }
    } else {
        if (slideIndex === 1) {
            slideIndex = scenes[currentSceneIndex[taskName]].images.length;
        } else {
            slideIndex += n;
        }
    }

    showSlides(slideIndex, taskName);
}

function showScene(sceneIndex, taskName) {
    currentSceneIndex[taskName] = sceneIndex;
    slideIndex = 1;
    showSlides(slideIndex, taskName);
}

function showSlides(n, taskName) {
    console.log("showSlides", n, taskName);
    let slides = $(`.${taskName}-mySlides`);
    let dots = $(`.${taskName}-demo`);
    let captionText = $(`#${taskName}-caption`);
    let scenes = data[taskName]["data"];
    let use_20 = data[taskName]["use_20"];
    let use_two_sided = data[taskName]["use_two_sided"];

    if (n > slides.length) { slideIndex = 1; }
    if (n < 1) { slideIndex = slides.length; }

    slides.hide();
    dots.removeClass("active");

    if (use_20) {
        let sceneSlides = $(`.${taskName}-scene-${currentSceneIndex[taskName]}`);
        sceneSlides.eq(slideIndex - 1).show();

        $(".twenty-container").twentytwenty();
        $(".twenty-container").css("height", "500px");
    } else if (use_two_sided) {
        // Update the input image on the left side
        let currentScene = scenes[currentSceneIndex[taskName]];
        $(`#${taskName}-container .col-sm-4 img`).attr('src', currentScene.input_image);
        
        // Show the current slide on the right side
        let sceneSlides = $(`.${taskName}-scene-${currentSceneIndex[taskName]}`);
        sceneSlides.eq(slideIndex - 1).show();
    } else {
        let sceneSlides = $(`.${taskName}-scene-${currentSceneIndex[taskName]}`);
        sceneSlides.eq(slideIndex - 1).show();
    }
    
    dots.eq(currentSceneIndex[taskName]).addClass("active");
    if (typeof scenes[currentSceneIndex[taskName]].title === 'string') {
        captionText.html(scenes[currentSceneIndex[taskName]].title);
    } else {
        captionText.html(scenes[currentSceneIndex[taskName]].title[slideIndex - 1]);
    }
}

// Generate the slides on page load
$(document).ready(function() {
    tasks.forEach(task => {
        generateSlides(task);
    });

    // Tab Logic
    $('.nav-tabs a').on('click', function(e) {
        e.preventDefault();

        let targetId = $(this).attr('href');

        // Update active tab
        $('.nav-tabs li').removeClass('active');
        $(this).parent('li').addClass('active');

        // Update tab content
        $('.tab-pane').removeClass('in active').addClass('fade');
        $(targetId).addClass('in active').removeClass('fade');
        $('#teaser-container').addClass('in active');
        
        // split using "-" and get the first element
        let taskName = targetId.split("-")[0].replace("#", "");
        console.log("Tab clicked", taskName);

        $(`.${taskName}-mySlides`).each(function() {
            const $slide = $(this);
            const $container = $slide.find('.twenty-container');
            
            console.log($container)

            // Remove only the overlay within this slide
            $('.twentytwenty-overlay').remove();
            
            // Remove only the handle within this slide
            $('.twentytwenty-handle').remove();
            
            // bug still persists.
            // console.log($slide.find(`.${taskName}-wrapper`))
            
            // // Move the container outside the wrapper but keep it within image2pose-mySlides
            // $container.insertBefore($container.parent().parent());
            
            // Remove the empty wrapper within this slide
            // $slide.find('.twentytwenty-wrapper').remove();
            
            // // Clean up any remaining empty elements within this slide
            // $slide.find('.twentytwenty-wrapper').each(function() {
            //     if ($(this).children().length === 0) {
            //         $(this).remove();
            //     }
            // });
            
            // console.log($slide.find('.twenty-container'))
            // $slide.find('.twenty-container').twentytwenty();
            // $slide.find('.twenty-container').css("height", "500px");
        });
        
        $('.twenty-container').twentytwenty();
        $('.twenty-container').css("height", "500px");
        twenty_inited[targetId] = true;
    });

    // Thumbnail click event
    $(document).on('click', '.cursor', function() {
        let taskName = $(this).attr('class').split('-')[0];
        let sceneIndex = $(this).data('scene-index');
        showScene(sceneIndex, taskName);
    });

    // Navigation arrows click event
    $(document).on('click', '.prev, .next, .two-prev, .two-next', function() {
        let taskName = $(this).data('task-name');
        let direction = ($(this).hasClass('prev') || $(this).hasClass('two-prev')) ? -1 : 1;
        plusSlides(direction, taskName);
    });
});